<!-- ///// FILTERS //// -->
<div class="filters-cover"> <!-- catalog-filters.js -->
	@@include('./cities-json.html')
	<!-- header always visible -->
	<div class="filter-header">
		<div class="row bottom-xs">
			<!-- hidden on mobile -->
			<div class="hidden-xs col-xs-12 col-sm-4 col-lg-3">
				<!-- toggle fiter button -->
				<button type="button" class="button button-primary button-block button-arrow full-sm" aria-label="open filter" data-toggle="#filtersInner">
					<span class="text">Фільтри (<span class="counter">0</span>)</span>
					<span class="button-icon">
						<i class="icon icon-arrow-right"></i>
					</span>
				</button>
				<!-- / toggle fiter button -->
			</div>
			<!-- / hidden on mobile -->
			<div class="col-xs-12 col-sm-4 col-sm-offset-4 col-lg-3 col-lg-offset-6 mobile-cover">
				<!-- visible only on mobile filter open -->
				<button type="button" class="button round-link" aria-label="open filter" data-toggle="#filtersInner">
					<i class="icon icon-filter"></i>
					<span class="counter">0</span>
				</button>
				<!-- / visible only on mobile filter open -->
				<!-- sorting select -->
				<div class="form-group select-group labeled-group">
					<label for="sorting" class="label">Сортувати за</label>
					<select name="filter[sorting]" id="sorting" class="select" data-selecter="skip">
						<option value="newest" data-value="Найновіші оголошення" selected>Найновіші оголошення</option>
						<option value="oldest" data-value="Найстаріші оголошення">Найстаріші оголошення</option>
						<option value="price_asc" data-value="Дешевші спочатку">Дешевші спочатку</option>
						<option value="price_desc" data-value="Дорожчі спочатку">Дорожчі спочатку</option>
					</select>
				</div>
				<!-- / sorting select -->
			</div>
		</div>
	</div>
	<!-- header -->

	<!-- inner content with filters and form -->
	<div class="filters-inner" id="filtersInner">
		<!-- visible only on mobile filter close -->
		<button type="button" class="button round-link" aria-label="open filter" data-toggle="#filtersInner">
			<i class="icon icon-cross"></i>
		</button>
		<!-- / visible only on mobile filter close -->
		<!-- if we have some selected filters need to show tag -->
		<form action="#" method="get" class="filters-form form" id="filterForm">
			<div class="row">
				<!-- 1 -->
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-3">
					<div class="labeled-group filter-group form-group" data-filter="[data-options] .item"  data-filter-fields="[data-label]">
						<span class="label">Місто</span>
						<div class="inner">
							<input type="text" class="input" id="city" data-minlength="2" placeholder="Введіть назву">
							<i class="icon icon-search"></i>
							<div class="filtered-list" data-options>
								<!-- 1 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="kyiv" type="radio" name="filter[city]" class="radio" id="city-kyiv">
										<label for="city-kyiv" class="radio-label" data-label>Київ</label>
									</div>
								</div>
								<!-- 2 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="kharkiv" type="radio" name="filter[city]" class="radio" id="city-kharkiv">
										<label for="city-kharkiv" class="radio-label" data-label>Харків</label>
									</div>
								</div>
								<!-- 3 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="dnipro" type="radio" name="filter[city]" class="radio" id="city-dnipro">
										<label for="city-dnipro" class="radio-label" data-label>Дніпро</label>
									</div>
								</div>
								<!-- 4 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="uzhgorod" type="radio" name="filter[city]" class="radio" id="city-uzhgorod">
										<label for="city-uzhgorod" class="radio-label" data-label>Ужгород</label>
									</div>
								</div>
								<!-- 5 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="mykolaiv" type="radio" name="filter[city]" class="radio" id="city-mykolaiv">
										<label for="city-mykolaiv" class="radio-label" data-label>Миколаїв</label>
									</div>
								</div>
								<!-- 6 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="kropyvnytskyi" type="radio" name="filter[city]" class="radio" id="city-kropyvnytskyi">
										<label for="city-kropyvnytskyi" class="radio-label" data-label>Кропивницький</label>
									</div>
								</div>
								<!-- 6 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="vinnytsia" type="radio" name="filter[city]" class="radio" id="city-vinnytsia">
										<label for="city-vinnytsia" class="radio-label">Вінниця</label>
									</div>
								</div>
								<!-- 7 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="poltava" type="radio" name="filter[city]" class="radio" id="city-poltava">
										<label for="city-poltava" class="radio-label">Полтава</label>
									</div>
								</div>
								<!-- 8 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="khmelnytskyi" type="radio" name="filter[city]" class="radio" id="city-khmelnytskyi">
										<label for="city-khmelnytskyi" class="radio-label">Хмельницький</label>
									</div>
								</div>
								<!-- 9 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="odesa" type="radio" name="filter[city]" class="radio" id="city-odesa">
										<label for="city-odesa" class="radio-label">Одеса</label>
									</div>
								</div>
								<!-- 10 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="ivano-frankivsk" type="radio" name="filter[city]" class="radio" id="city-ivano-frankivsk">
										<label for="city-ivano-frankivsk" class="radio-label">Івано-Франківськ</label>
									</div>
								</div>
								<!-- 11 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="chernihiv" type="radio" name="filter[city]" class="radio" id="city-chernihiv">
										<label for="city-chernihiv" class="radio-label">Чернігів</label>
									</div>
								</div>
								<!-- 12 -->
								<div class="item">
									<div class="radio-group form-group">
										<input value="lutsk" type="radio" name="filter[city]" class="radio" id="city-lutsk">
										<label for="city-lutsk" class="radio-label">Луцьк</label>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- 2 -->
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-3">
					<div class="labeled-group filter-group form-group disabled" data-filter="[data-options]" data-filter-fields="[data-label]">
						<span class="label">Район</span>
						<div class="inner">
							<input type="text" class="input" id="district" data-minlength="2" placeholder="Введіть назву">
							<i class="icon icon-search"></i>
							<div class="alert-helper">Щоб обрати район, спочатку оберіть місто</div>
							<div class="filtered-list" data-options>
								<!-- 1 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-holosiivskyi" value="holosiivskyi">
										<label data-label for="district-holosiivskyi" class="checkbox-label">Голосіївський</label>
									</div>
								</div>
								<!-- 2 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-darnytskyi" value="darnytskyi">
										<label data-label for="district-darnytskyi" class="checkbox-label">Дарницький</label>
									</div>
								</div>
								<!-- 3 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-desnyanskyi" value="desnyanskyi">
										<label data-label for="district-desnyanskyi" class="checkbox-label">Деснянський</label>
									</div>
								</div>
								<!-- 4 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-dniprovskiy" value="dniprovskiy">
										<label data-label for="district-dniprovskiy" class="checkbox-label">Дніпровський</label>
									</div>
								</div>
								<!-- 5 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-obolonskyi" value="obolonskyi">
										<label data-label for="district-obolonskyi" class="checkbox-label">Оболонський</label>
									</div>
								</div>
								<!-- 6 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-kropyvnytskyi" value="kropyvnytskyi">
										<label data-label for="district-kropyvnytskyi" class="checkbox-label">Кропивницький</label>
									</div>
								</div>
								<!-- 7 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-pecherskyi" value="pecherskyi">
										<label data-label for="district-pecherskyi" class="checkbox-label">Печерський</label>
									</div>
								</div>
								<!-- 8 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-podilskyi" value="podilskyi">
										<label data-label for="district-podilskyi" class="checkbox-label">Подільський</label>
									</div>
								</div>
								<!-- 9 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-sviatoshynskyi" value="sviatoshynskyi">
										<label data-label for="district-sviatoshynskyi" class="checkbox-label">Святошинський</label>
									</div>
								</div>
								<!-- 10 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-solomyanskyi" value="solomyanskyi">
										<label data-label for="district-solomyanskyi" class="checkbox-label">Солом’янський</label>
									</div>
								</div>
								<!-- 11 -->
								<div class="item">
									<div class="checkbox-group form-group">
										<input name="filter[district][]" type="checkbox" class="checkbox" id="district-shevchenkivskyi" value="shevchenkivskyi">
										<label data-label for="district-shevchenkivskyi" class="checkbox-label">Шевченківський</label>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- 3 -->
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-3">
					<div class="labeled-group date-group calendar-group" data-calendar>
						<span class="label">Дата</span>
						<div class="range-header">Не вибрано</div>
						<div class="inner">
							<div class="date-group">
								<div class="date-select">
									<label for="startDatetime" class="label">Початок</label>
									<input type="date" id="startDatetime" name="filter[startDatetime]" data-start class="input">
								</div>
								<div class="date-select">
									<label for="endDatetime" class="label">Кінець</label>
									<input type="date" id="endDatetime" name="filter[endDatetime]" data-end class="input">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<!-- 4 -->
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-3">
					<div class="labeled-group form-group" data-range>
						<span class="label">Загальна площа</span>
						<div class="range-header">Не вибрано</div>
						<div class="inner">
							<div class="range-group">
								<div class="range-inputs">
									<div class="form-group input-group">
										<label class="label">Від м<sup>2</sup></label>
										<input type="number" class="input input-min" name="filter[area_min]">
									</div>
									<div class="form-group input-group">
										<label class="label">До м<sup>2</sup></label>
										<input type="number" class="input input-max" name="filter[area_max]">
									</div>
								</div>
								<div class="range-group">
									<div class="range"
										data-min="20"
										data-max="1000"
										data-step="10"
										data-ticks="5"
										data-value-min=""
										data-value-max="">
										<input type="range" class="range-min" aria-label="Minimum">
										<input type="range" class="range-max" aria-label="Maximum">
										<div class="range-progress">
											<div class="range-track"></div>
											<div class="range-fill"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- 5 -->
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-3">
					<div class="form-group range-group labeled-group" data-range>
						<span class="label">Поверх</span>
						<div class="range-header">Не вибрано</div>
						<div class="inner">
							<div class="range-group">
								<div class="range-inputs">
									<div class="form-group input-group">
										<label class="label">Від (поверх)</label>
										<input type="number" class="input input-min" name="filter[floor_min]">
									</div>
									<div class="form-group input-group">
										<label class="label">До (поверх)</label>
										<input type="number" class="input input-max" name="filter[floor_max]">
									</div>
								</div>
								<div class="range-group">
									<div class="range"
										data-min="1"
										data-max="40"
										data-step="1"
										data-ticks="5"
										data-value-min=""
										data-value-max="">
										<input type="range" class="range-min" aria-label="Minimum">
										<input type="range" class="range-max" aria-label="Maximum">
										<div class="range-progress">
											<div class="range-track"></div>
											<div class="range-fill"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- 6 -->
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-3">
					<div class="form-group range-group labeled-group" data-range>
						<span class="label">Бюджет</span>
						<div class="range-header">Не вибрано</div>
						<div class="inner">
							<div class="range-group">
								<div class="range-inputs">
									<div class="form-group input-group">
										<label class="label">Від (грн)</label>
										<input type="number" class="input input-min" name="filter[price_min]">
									</div>
									<div class="form-group input-group">
										<label class="label">До (грн)</label>
										<input type="number" class="input input-max" name="filter[price_max]">
									</div>
								</div>
								<div class="range-group">
									<div class="range"
										data-min="1000"
										data-max="50000"
										data-step="100"
										data-ticks="5"
										data-value-min=""
										data-value-max="">
										<input type="range" class="range-min" aria-label="Minimum">
										<input type="range" class="range-max" aria-label="Maximum">
										<div class="range-progress">
											<div class="range-track"></div>
											<div class="range-fill"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-3 align-right">
					<!-- submit -->
					<div class="button-cover">
						<button type="submit" class="button button-block button-primary-invert button-arrow full-sm" aria-label="open filter">
							<span class="text">Застосувати</span>
							<span class="button-icon">
								<i class="icon icon-arrow-right"></i>
							</span>
						</button>
					</div>
					<!-- / submit -->
				</div>
			</div>
		</form>
	</div>
	<!-- / inner contents with filters and form -->
	<!-- if we have some selected filters need to show tag and remove class hidden-->
	<!-- TAGS -->
	<div class="tag-cover hidden">
		<div class="tag-list">
		</div>
		<button class="button-link button" type="button">Очистити все</button>
	</div>
</div>
<!-- ///// FILTERS //// -->

<!-- Отримуємо і обробляємо GET -->
<script>
	document.addEventListener('DOMContentLoaded', () => {
		const form = document.getElementById('filterForm');
		if (!form) return;

		const params = new URLSearchParams(location.search);

		/* =====================================================
		 * 1. RADIO / INPUT / DATE (filter[...])
		 * ===================================================== */
		params.forEach((value, key) => {
			if (!key.startsWith('filter[')) return;
			if (key.endsWith('[]')) return;

			form.querySelectorAll(`[name="${CSS.escape(key)}"]`).forEach(el => {
				if (el.type === 'radio') {
					el.checked = el.value === value;
				} else {
					el.value = value;
				}
			});
		});

		/* =====================================================
		 * 2. CHECKBOX ARRAYS
		 * ===================================================== */
		params.forEach((_, key) => {
			if (!key.startsWith('filter[')) return;
			if (!key.endsWith('[]')) return;

			const values = params.getAll(key);
			form.querySelectorAll(`[name="${CSS.escape(key)}"]`).forEach(cb => {
				cb.checked = values.includes(cb.value);
			});
		});

		/* =====================================================
		 * 3. RANGE + SORTING (ПІСЛЯ ІНІЦІАЛІЗАЦІЙ)
		 * ===================================================== */
		requestAnimationFrame(() => {

			/* ---------- RANGE ---------- */
			document.querySelectorAll('[data-range]').forEach(block => {
				const group = block.querySelector('.range-group');
				const dr = group?._dualRange;
				if (!dr) return;

				const nameMin = group.querySelector('.input-min')?.name;
				const nameMax = group.querySelector('.input-max')?.name;

				if (!params.has(nameMin) || !params.has(nameMax)) return;

				dr.set(
					Number(params.get(nameMin)),
					Number(params.get(nameMax)),
					true
				);
			});

			/* ---------- SORTING ---------- */
			const sortingValue =
				params.get('filter[sorting]') ||
				params.get('sorting');

			if (sortingValue) {
				const select = document.getElementById('sorting');
				if (!select) return;

				// 1. sync native select
				select.value = sortingValue;

				// 2. sync Selecter UI (НЕ ЗАЛЕЖИТЬ ВІД skip)
				const selecter =
					select.nextElementSibling?.classList.contains('selecter')
						? select.nextElementSibling
						: null;

				if (selecter) {
					selecter.querySelectorAll('li').forEach(li => {
						li.classList.toggle(
							'active',
							li.dataset.value === sortingValue
						);
					});

					const opt = select.querySelector(
						`option[value="${CSS.escape(sortingValue)}"]`
					);
					const anchor = selecter.querySelector('.anchor');

					if (opt && anchor) {
						anchor.textContent =
							opt.dataset.value ||
							opt.textContent.trim();
					}
				}
			}

			/* ---------- TAGS ---------- */
			document.querySelectorAll('.filters-cover').forEach(el => {
				el._filtersUI?.rebuild?.();
			});
		});
	});
</script>

<!-- Відправляємо GET -->
<script>
	document.addEventListener('DOMContentLoaded', () => {
		const form = document.getElementById('filterForm');
		if (!form) return;

		form.addEventListener('submit', e => {
			e.preventDefault();

			const params = new URLSearchParams(window.location.search);

			// 1. очищаємо ВСІ filter[…]
			[...params.keys()].forEach(key => {
				if (key.startsWith('filter[')) {
					params.delete(key);
				}
			});

			// 2. додаємо значення з форми
			new FormData(form).forEach((value, key) => {
				if (value !== '') params.append(key, value);
			});

			// 3. ⬅️ ДОДАЄМО sorting (він поза form)
			const sorting = document.querySelector('[name="filter[sorting]"]');
			if (sorting && sorting.value) {
				params.set('filter[sorting]', sorting.value);
			}

			window.location.href =
				location.pathname +
				(params.toString() ? '?' + params.toString() : '');
		});
	});
</script>

<!-- Сортування -->
<!-- SORTING: li click → preserve GET + set filter[sorting] -->
<script>
	document.addEventListener('click', (e) => {
		const li = e.target.closest('.selecter li[data-value]');
		if (!li) return;

		const value = li.dataset.value;
		if (!value) return;

		// беремо ПОТОЧНИЙ URL з усіма параметрами
		const url = new URL(window.location.href);

		// перезаписуємо / додаємо ТІЛЬКИ filter[sorting]
		url.searchParams.set('filter[sorting]', value);

		url.hash = '';
		window.location.href = url.toString();
	});
</script>

